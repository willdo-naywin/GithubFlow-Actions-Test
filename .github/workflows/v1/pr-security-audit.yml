name: PR Security Audit and Branch Check

on:
  pull_request:
    branches:
      - main
      - master
    types: [opened, synchronize, reopened]

jobs:
  branch-check:
    name: Check Branch Name
    runs-on: ubuntu-latest
    steps:
      - name: Validate branch name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          BASE_BRANCH="${{ github.base_ref }}"
          echo "ðŸ” Checking PR: $BRANCH_NAME â†’ $BASE_BRANCH"
          
          # Only enforce branch naming rules if targeting main or master
          if [[ "$BASE_BRANCH" =~ ^(main|master)$ ]]; then
            echo "ðŸ“Œ Target is protected branch ($BASE_BRANCH), checking source branch name..."
            
            if [[ "$BRANCH_NAME" =~ ^(release-|hotfix-) ]]; then
              echo "âœ… Branch name is valid: $BRANCH_NAME â†’ $BASE_BRANCH"
              exit 0
            else
              echo "âŒ ERROR: Branch name must start with 'release-' or 'hotfix-' when merging to $BASE_BRANCH"
              echo "Current branch: $BRANCH_NAME"
              echo ""
              echo "Valid examples:"
              echo "  - release-1.0.0"
              echo "  - release-v2.5.1"
              echo "  - hotfix-security-patch"
              echo "  - hotfix-critical-bug"
              exit 1
            fi
          else
            echo "âœ… Target branch is $BASE_BRANCH (not main/master), skipping branch name validation"
            exit 0
          fi

  npm-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Run npm audit
        id: npm-audit
        continue-on-error: true
        run: |
          echo "## ðŸ“¦ NPM Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.head_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run audit and capture output
          if npm audit --json > audit-result.json 2>&1; then
            echo "âœ… No vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Vulnerabilities detected!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Parse JSON output for summary
            CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' audit-result.json)
            HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' audit-result.json)
            MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' audit-result.json)
            LOW=$(jq -r '.metadata.vulnerabilities.low // 0' audit-result.json)
            INFO=$(jq -r '.metadata.vulnerabilities.info // 0' audit-result.json)
            TOTAL=$(jq -r '.metadata.vulnerabilities.total // 0' audit-result.json)
            
            echo "### Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "| â„¹ï¸ Info | $INFO |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Display detailed audit output
            echo "### Detailed Audit Report" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            npm audit >> $GITHUB_STEP_SUMMARY 2>&1 || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  composer-audit:
    name: Composer Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json
          coverage: none

      - name: Run composer audit
        id: composer-audit
        continue-on-error: true
        run: |
          echo "## ðŸŽ¼ Composer Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.head_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run audit and capture output
          if composer audit --format=json > composer-audit-result.json 2>&1; then
            echo "âœ… No vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Vulnerabilities detected!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Parse JSON output for summary (if available)
            if [ -f composer-audit-result.json ] && jq empty composer-audit-result.json 2>/dev/null; then
              ADVISORIES=$(jq -r '.advisories // {} | length' composer-audit-result.json 2>/dev/null || echo "0")
              
              echo "### Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Total Advisories:** $ADVISORIES" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # List affected packages
              if [ "$ADVISORIES" -gt 0 ]; then
                echo "### Affected Packages" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                jq -r '.advisories | to_entries[] | "- **\(.key)**: \(.value | length) advisory(ies)"' composer-audit-result.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            # Display detailed audit output
            echo "### Detailed Audit Report" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            composer audit --format=plain >> $GITHUB_STEP_SUMMARY 2>&1 || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  security-summary:
    name: Security Audit Summary
    runs-on: ubuntu-latest
    needs: [npm-audit, composer-audit]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## ðŸ”’ Security Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All security audits have been completed." >> $GITHUB_STEP_SUMMARY
          echo "Please review the individual audit reports above." >> $GITHUB_STEP_SUMMARY
